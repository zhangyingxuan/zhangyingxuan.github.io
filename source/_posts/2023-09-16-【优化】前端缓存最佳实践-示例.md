title: 2023-09-16-ã€ä¼˜åŒ–ã€‘å‰ç«¯ç¼“å­˜æœ€ä½³å®è·µ-ç¤ºä¾‹
description: Web Workers æ˜¯é€šç”¨çš„â€œåå°è®¡ç®—çº¿ç¨‹â€ï¼ŒService Workers æ˜¯ç‰¹æ®Šçš„â€œç½‘ç»œä»£ç†çº¿ç¨‹â€ï¼ˆä¸“ä¸º PWA ç¦»çº¿ç¼“å­˜ã€æ¨é€é€šçŸ¥ç­‰åœºæ™¯è®¾è®¡ï¼‰ã€‚
categories:

- ç ”å‘
  tags:
- web works
- service worker

åœ¨é«˜æ€§èƒ½ Web åº”ç”¨çš„ä¼˜åŒ–æ¸…å•é‡Œï¼Œ**ç¼“å­˜**æ°¸è¿œæ˜¯æŠ•å…¥äº§å‡ºæ¯”ï¼ˆROIï¼‰æœ€é«˜çš„ä¸€é¡¹ã€‚

ä»**æµè§ˆå™¨ç¼“å­˜ã€åº”ç”¨çº§ç¼“å­˜ã€ä»£ç çº§ç¼“å­˜**ä¸‰ä¸ªç»´åº¦ï¼Œæ¢³ç†ä¸€ä»½å¹²è´§æ»¡æ»¡çš„ã€Šå‰ç«¯ç¼“å­˜æ–¹æ¡ˆæœ€ä½³å®è·µã€‹ã€‚

## ğŸš€ å‰ç«¯ç¼“å­˜å…¨æ™¯æ¶æ„

åœ¨è¿›å…¥ä»£ç ç»†èŠ‚å‰ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡è¿™å¼ å›¾å»ºç«‹å…¨å±€è§†é‡ã€‚ç¼“å­˜çš„æœ¬è´¨æ˜¯ï¼š**è¶Šé è¿‘ç”¨æˆ·ï¼Œé€Ÿåº¦è¶Šå¿«ï¼Œæˆæœ¬è¶Šä½ã€‚**

```mermaid
graph TD
    User((ç”¨æˆ·)) --> BrowserCache[æµè§ˆå™¨å¼ºåˆ¶ç¼“å­˜]
    BrowserCache -- å‘½å¤±è´¥ -->åå•†ç¼“å­˜[æµè§ˆå™¨åå•†ç¼“å­˜]
    åå•†ç¼“å­˜ -- å¤±æ•ˆ --> ServiceWorker[Service Worker / PWA]
    ServiceWorker -- æ— è®°å½• --> MemoryCache[åº”ç”¨å†…å­˜ç¼“å­˜ / Vuex / Pinia]
    MemoryCache -- æ‰¾ä¸åˆ° --> DiskCache[æŒä¹…åŒ–å­˜å‚¨ / IndexedDB / LocalStorage]
    DiskCache -- ç»ˆç‚¹ --> Server((CDN / æºç«™æœåŠ¡å™¨))

```

## 1. æµè§ˆå™¨ HTTP ç¼“å­˜ï¼šæ€§èƒ½çš„åŸºçŸ³

è¿™æ˜¯æœ€åº•å±‚çš„ç¼“å­˜ç­–ç•¥ï¼Œç”± Web æœåŠ¡å™¨æ§åˆ¶ã€‚

### å¼ºç¼“å­˜ï¼ˆStrong Cacheï¼‰

- **æ ¸å¿ƒæŒ‡ä»¤**ï¼š`Cache-Control: max-age=31536000` (HTTP/1.1)
- **è¡¨ç°**ï¼šæµè§ˆå™¨ç›´æ¥ä»æœ¬åœ°è¯»å–ï¼ŒçŠ¶æ€ç ä¸º `200 (from disk cache)`ï¼Œä¸å‘è¯·æ±‚ã€‚
- **æœ€ä½³å®è·µ**ï¼š**åŠ¨é™åˆ†ç¦»**ã€‚
- **é™æ€èµ„æºï¼ˆJS/CSS/Imageï¼‰**ï¼šæ–‡ä»¶åå¸¦ä¸Š Content Hashï¼ˆå¦‚ `main.a8f2c.js`ï¼‰ï¼Œè®¾ç½®ä¸€å¹´å¼ºç¼“å­˜ã€‚
- **HTML å…¥å£æ–‡ä»¶**ï¼šè®¾ç½® `no-cache`ï¼Œç¡®ä¿ç”¨æˆ·æ¯æ¬¡éƒ½èƒ½æ‹¿åˆ°æœ€æ–°çš„èµ„æºé“¾æ¥ã€‚

### åå•†ç¼“å­˜ï¼ˆNegotiation Cacheï¼‰

- **æ ¸å¿ƒæŒ‡ä»¤**ï¼š`ETag` / `If-None-Match`
- **è¡¨ç°**ï¼šæµè§ˆå™¨å‘è¯·æ±‚è¯¢é—®æœåŠ¡å™¨â€œèµ„æºå˜äº†å—ï¼Ÿâ€ï¼Œè‹¥æœªå˜è¿”å› `304 Not Modified`ã€‚
- **æœ€ä½³å®è·µ**ï¼šé…åˆå¼ºç¼“å­˜ä½¿ç”¨ã€‚å½“å¼ºç¼“å­˜è¿‡æœŸï¼ŒETag æ ¡éªŒèƒ½é¿å…é‡å¤ä¸‹è½½æœªæ”¹å˜çš„èµ„æºã€‚

## 2. ç¦»çº¿ä¸é¢„å–ç¼“å­˜ï¼šService Worker

Service Worker æ˜¯ç‹¬ç«‹äºä¸»çº¿ç¨‹çš„â€œç½‘ç»œä»£ç†â€ï¼Œå®ƒæ˜¯å®ç°ç¦»çº¿åŒ–å’Œæè‡´åŠ è½½çš„å…³é”®ã€‚

- **ç­–ç•¥é€‰æ‹©**ï¼š

1. **Cache First**ï¼šé€‚ç”¨äºé™æ€å›¾æ ‡ã€å­—ä½“ã€‚
2. **Stale-While-Revalidate**ï¼š**æ¨èæ–¹æ¡ˆ**ã€‚ä¼˜å…ˆä½¿ç”¨ç¼“å­˜å¿«é€Ÿæ¸²æŸ“ï¼ŒåŒæ—¶åå°é™é»˜æ›´æ–°ï¼Œä¸‹æ¬¡è¿›å…¥é¡µé¢å³æ˜¯æœ€æ–°ç‰ˆã€‚
3. **Network First**ï¼šé€‚ç”¨äºå¯¹å®æ—¶æ€§è¦æ±‚æé«˜çš„ API è¯·æ±‚ã€‚

## 3. åº”ç”¨çŠ¶æ€å­˜å‚¨ï¼šå†…å­˜ä¸æŒä¹…åŒ–

æ ¹æ®æ•°æ®çš„**ç”Ÿå‘½å‘¨æœŸ**å’Œ**ä½“ç§¯**æ¥æŠ‰æ‹©å­˜å‚¨ä»‹è´¨ã€‚

| å­˜å‚¨æ–¹å¼ | å®¹é‡ | ç”Ÿå‘½å‘¨æœŸ | é€‚ç”¨åœºæ™¯ |
| | | -- | -- |
| **Pinia / Redux** | å†…å­˜é™åˆ¶ | é¡µé¢åˆ·æ–°å³å¤± | ç»„ä»¶é—´å…±äº«çŠ¶æ€ã€ä¸´æ—¶ä¸šåŠ¡æ•°æ® |
| **LocalStorage** | ~5MB | æ°¸ä¹… | ç”¨æˆ·åå¥½è®¾ç½®ã€ç®€å•çš„ Token |
| **SessionStorage** | ~5MB | æ ‡ç­¾é¡µå…³é—­å³å¤± | å•æ¬¡ä¼šè¯æ•°æ®ã€æ•æ„Ÿçš„ä¸´æ—¶è¡¨å• |
| **IndexedDB** | å¾ˆå¤§ (GB çº§) | æ°¸ä¹… | ç»“æ„åŒ–å¤§æ•°æ®ã€ç¦»çº¿æ–‡æ¡£ã€åœ°å›¾ç“¦ç‰‡ |

### ğŸ›  æœ€ä½³å®è·µä»£ç ï¼šå¸¦è¿‡æœŸæ—¶é—´çš„ LocalStorage å°è£…

åŸç”Ÿçš„ `localStorage` æ²¡æ³•è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿™åœ¨ä¸šåŠ¡ä¸­å¾ˆå±é™©ã€‚

```javascript
const storage = {
  set(key, value, expireMinutes) {
    const data = {
      value,
      expire: expireMinutes ? Date.now() + expireMinutes * 60000 : null,
    };
    localStorage.setItem(key, JSON.stringify(data));
  },
  get(key) {
    const data = JSON.parse(localStorage.getItem(key));
    if (!data) return null;
    if (data.expire && Date.now() > data.expire) {
      localStorage.removeItem(key);
      return null;
    }
    return data.value;
  },
};
```

## 4. API è¯·æ±‚ç¼“å­˜ï¼šé˜²æŠ–ä¸èŠ‚æµçš„è¿›é˜¶ç‰ˆ

åœ¨å¤æ‚çš„ SaaS åº”ç”¨ä¸­ï¼ŒåŒä¸€ä¸ªæ¥å£å¯èƒ½åœ¨ 1 ç§’å†…è¢«è°ƒç”¨ 5 æ¬¡ã€‚

**æ–¹æ¡ˆï¼šè¯·æ±‚æ‹¦æˆªå™¨ç¼“å­˜ (Request Deduplication)**
åœ¨è¯·æ±‚æ‹¦æˆªå™¨ä¸­ï¼Œä»¥ `Method + URL + Params` ä¸º Keyã€‚å¦‚æœä¸Šä¸€ä¸ªç›¸åŒè¯·æ±‚è¿˜æ²¡ç»“æŸï¼Œç›´æ¥è¿”å›ä¸Šä¸€ä¸ªè¯·æ±‚çš„ Promiseã€‚

```mermaid
sequenceDiagram
    participant Component A
    participant Component B
    participant Interceptor
    participant Server

    Component A->>Interceptor: è¯·æ±‚ /api/user/1
    Interceptor->>Server: å‘å‡ºçœŸå®ç½‘ç»œè¯·æ±‚
    Component B->>Interceptor: è¯·æ±‚ /api/user/1 (å¹¶å‘)
    Note over Interceptor: å‘ç°ç›¸åŒçš„è¯·æ±‚æ­£åœ¨è¿›è¡Œ
    Interceptor-->>Component B: è¿”å› Pending ä¸­çš„åŒä¸€ä¸ª Promise
    Server-->>Interceptor: æ•°æ®è¿”å›
    Interceptor-->>Component A: ç»“æœ
    Interceptor-->>Component B: ç»“æœ

```

## æ€»ç»“ï¼šâ€œé¿å‘â€é”¦å›Š

1. **ä¸è¦è¿‡åº¦ç¼“å­˜ HTML**ï¼šHTML å¦‚æœè¢«å¼ºç¼“å­˜ï¼Œä½ å‘å¸ƒçš„æ–°ç‰ˆæœ¬ç”¨æˆ·æ°¸è¿œæ”¶ä¸åˆ°ã€‚
2. **æ¸…ç†ç­–ç•¥**ï¼šç¼“å­˜ä¸æ˜¯åªè¿›ä¸å‡ºçš„ã€‚åœ¨ä½¿ç”¨ IndexedDB æˆ– LocalStorage æ—¶ï¼ŒåŠ¡å¿…è®¾è®¡ç‰ˆæœ¬å·å¯¹æ¯”æœºåˆ¶ï¼Œç‰ˆæœ¬æ›´æ–°æ—¶æ¸…ç©ºæ—§ç¼“å­˜ã€‚
3. **å®‰å…¨æ•æ„Ÿ**ï¼šä¸¥ç¦åœ¨ LocalStorage å­˜å‚¨ä¸ªäººæ•æ„Ÿä¿¡æ¯ï¼ˆèº«ä»½è¯å·ã€æ‰‹æœºå·ï¼‰ï¼Œé˜²æ­¢ XSS æ”»å‡»è¢«ä¸€é”…ç«¯ã€‚

## é—®é¢˜é›†

1. **é˜²å¾¡æ€§ç¼–ç¨‹**ï¼Œï¼ˆAPI æ¥å£ï¼‰ç¦ç”¨å¼ºç¼“å­˜ï¼ˆCache-Control: no-cacheï¼‰ï¼Œé¿å…è¿”å›æ—§æ•°æ®ï¼›ä»¥ axios ä¸ºä¾‹ï¼š

- 1.1 å…¨å±€æ‹¦æˆªå™¨æ³¨å…¥ Header

```js
import axios from "axios";

const instance = axios.create();

instance.interceptors.request.use(
  (config) => {
    // é’ˆå¯¹æ‰€æœ‰è¯·æ±‚ç¦ç”¨å¼ºç¼“å­˜
    config.headers["Cache-Control"] = "no-cache, no-store, must-revalidate";
    config.headers["Pragma"] = "no-cache"; // å…¼å®¹ HTTP/1.0
    config.headers["Expires"] = "0"; // å…è®¸ä»£ç†æœåŠ¡å™¨ç«‹å³è¿‡æœŸ

    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);
```

> æ³¨ï¼šé€šå¸¸åªéœ€è¦å¯¹ GET è¯·æ±‚åšå¤„ç†ï¼ŒPOST/PUT/DELETE æœ¬èº«åœ¨è¯­ä¹‰ä¸Šå°±æ˜¯éå¹‚ç­‰æˆ–æ”¹å˜æ•°æ®çš„ï¼Œæµè§ˆå™¨é»˜è®¤ä¸ç¼“å­˜ã€‚
> no-cache: å¼ºåˆ¶æµè§ˆå™¨åœ¨ä½¿ç”¨ç¼“å­˜å‰¯æœ¬å‰å…ˆå‘æœåŠ¡å™¨ç¡®è®¤ï¼ˆåå•†ç¼“å­˜ï¼‰ã€‚
> no-store: ç¦æ­¢æµè§ˆå™¨åŠæ‰€æœ‰ä¸­é—´ä»£ç†å­˜å‚¨ä»»ä½•ç¼“å­˜å†…å®¹ï¼ˆå½»åº•ç¦ç”¨ç¼“å­˜ï¼‰ã€‚
> must-revalidate: ä¸€æ—¦èµ„æºè¿‡æœŸï¼Œå¿…é¡»é‡æ–°å‘æºæœåŠ¡å™¨æ ¡éªŒã€‚

- 1.2 URL åŠ¨æ€æ—¶é—´æˆ³ï¼ˆæœ€å¼ºåˆ¶æ–¹æ¡ˆï¼‰
  æœ‰æ—¶å³ä¾¿è®¾ç½®äº† Headerï¼ŒæŸäº›æå…¶é¡½å›ºçš„ä»£ç†æœåŠ¡å™¨ä»å¯èƒ½è¿”å›ç¼“å­˜ã€‚æ­¤æ—¶ï¼Œæ”¹å˜ URL å”¯ä¸€æ€§æ˜¯ç»ˆææ€æ‹›ã€‚

```js
instance.interceptors.request.use((config) => {
  // ä»…é’ˆå¯¹ GET è¯·æ±‚æ·»åŠ éšæœºå‚æ•°
  if (config.method === "get") {
    config.params = {
      ...config.params,
      _t: Date.now(), // æˆ–è€…ä½¿ç”¨ Math.random()
    };
  }
  return config;
});
```

> åŸç†ï¼šæµè§ˆå™¨æ˜¯ä»¥ URLï¼ˆåŒ…æ‹¬å‚æ•°ï¼‰ä½œä¸ºç¼“å­˜çš„ Keyã€‚
> æ•ˆæœï¼šæ¯æ¬¡è¯·æ±‚çš„ URL éƒ½æ˜¯å…¨æ–°çš„ï¼ˆä¾‹å¦‚ /api/user?\_t=1734433221ï¼‰ï¼Œæµè§ˆå™¨æ— æ³•ä»ç¼“å­˜åº“ä¸­åŒ¹é…åˆ°è¯¥ Keyï¼Œä»è€Œè¢«è¿«å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚

- 1.3 æœåŠ¡ç«¯ç¦ç”¨ç¼“å­˜ nginx é…ç½®

```json
location /api/ {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    proxy_pass http://your_backend;
}
```
