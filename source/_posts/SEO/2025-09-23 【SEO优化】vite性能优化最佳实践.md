---
title: 2025-09-23 ã€æ¶æ„ã€‘viteæ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ
description:
categories:
  - æ¶æ„è®¾è®¡
tags:
  - vite
  - RUM
---

Vite çš„ä¼˜åŒ–ä¸»è¦åˆ†ä¸º **å¼€å‘ä½“éªŒï¼ˆDev Speedï¼‰**ã€**æ„å»ºæ€§èƒ½ï¼ˆBuild Speedï¼‰** å’Œ **äº§ç‰©è´¨é‡ï¼ˆBundle Qualityï¼‰** ä¸‰ä¸ªç»´åº¦ã€‚

å¯¹äºä¸€ä¸ªæ ‡å‡†çš„ Vite é¡¹ç›®ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒå±‚é¢è¿›è¡Œæ·±åº¦ä¼˜åŒ–ï¼š

---

## ä¸€ã€ æ„å»ºäº§ç‰©ä¼˜åŒ–ï¼ˆBundle Qualityï¼‰

è¿™æ˜¯ä¼˜åŒ–æœ€æœ‰æ„Ÿçš„éƒ¨åˆ†ï¼Œç›´æ¥å½±å“ç”¨æˆ·è®¿é—®ä½ çš„ç½‘ç«™æ—¶çš„é¦–å­—èŠ‚æ—¶é—´ï¼ˆTTFBï¼‰å’Œé¡µé¢åŠ è½½é€Ÿåº¦ã€‚

### 1. åˆ†åŒ…ç­–ç•¥ (Manual Chunks)

é»˜è®¤æƒ…å†µä¸‹ï¼ŒVite ä¼šå°†æ‰€æœ‰ JS æ‰“åŒ…åœ¨ä¸€èµ·ã€‚åˆ©ç”¨ `rollupOptions` å°†å¤§å‹ç¬¬ä¸‰æ–¹åº“æ‹†åˆ†å‡ºæ¥ï¼Œå¯ä»¥æœ‰æ•ˆåˆ©ç”¨æµè§ˆå™¨ç¼“å­˜ã€‚

```javascript
// vite.config.js
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          "vue-vendor": ["vue", "vue-router", "pinia"],
          "ui-vendor": ["element-plus", "antd"], // è¾ƒå¤§çš„ UI åº“å•ç‹¬æ‰“åŒ…
        },
      },
    },
  },
});
```

### 2. å¯ç”¨é¢„å‹ç¼© (Gzip & Brotli)

å‰ç«¯éœ€è¦åœ¨æ„å»ºæ—¶ï¼ŒåŒæ—¶ç”Ÿæˆ `.gz` åŠ `.br` æ–‡ä»¶ã€‚ä½¿ç”¨ `vite-plugin-compression`ã€‚

```javascript
import compress from "vite-plugin-compression";

plugins: [
  // 1. ç”Ÿæˆ .gz æ–‡ä»¶
  compress({
    algorithm: "gzip",
    ext: ".gz",
    threshold: 10240, // è¶…è¿‡ 10kb æ‰å‹ç¼©
    deleteOriginFile: false, // åˆ‡è®°ï¼šä¸è¦åˆ é™¤æºæ–‡ä»¶ï¼
  }),
  // 2. ç”Ÿæˆ .br æ–‡ä»¶
  compress({
    algorithm: "brotliCompress",
    ext: ".br",
    threshold: 10240,
    deleteOriginFile: false,
  }),
];
```

> æè‡´æ€§èƒ½ä¸ä¿åº•å…¼å®¹çš„å®Œç¾å¹³è¡¡ï¼›è¿™æ˜¯â€œæ€§èƒ½ä¸Šé™â€ä¸â€œå…¼å®¹ä¸‹é™â€çš„åšå¼ˆï¼š
> Brotli (br) æ˜¯ä¸Šé™ï¼šå®ƒçš„å‹ç¼©ç‡æ¯” Gzip é«˜å‡º 17%-25%ã€‚è¿™æ„å‘³ç€åŒæ ·çš„ JS æ–‡ä»¶ï¼Œç”¨ br ä¼ è¾“ä¼šæ›´å°ï¼Œç”¨æˆ·æ‰“å¼€ä½ çš„â€œå­¦ä¹ ç±»ç½‘ç«™â€é€Ÿåº¦æ›´å¿«ã€‚
> Gzip (gz) æ˜¯ä¸‹é™ï¼šè™½ç„¶ br å·²ç»è¦†ç›–äº† 95% ä»¥ä¸Šçš„ç°ä»£æµè§ˆå™¨ï¼Œä½†ä»æœ‰æå°‘æ•°åœºæ™¯ï¼ˆå¦‚æ—§ç‰ˆ Android æµè§ˆå™¨ã€æŸäº›å…¬å¸å†…ç½‘çš„è¿‡æ—¶ä»£ç†æœåŠ¡å™¨ã€æˆ–è€…ç‰¹å®šçš„çˆ¬è™«ï¼‰ä¸æ”¯æŒ brã€‚æ­¤æ—¶ï¼ŒGzip å°±æ˜¯æœ€ç¨³å¦¥çš„ä¿åº•æ–¹æ¡ˆã€‚

---

## äºŒã€ é™æ€èµ„æºä¸å›¾ç‰‡ä¼˜åŒ–

å›¾ç‰‡é€šå¸¸å é¡µé¢ä½“ç§¯çš„ 70% ä»¥ä¸Šã€‚

### 1. å›¾ç‰‡å‹ç¼©ä¸è½¬ç 

ä½¿ç”¨ `vite-imagetools` åœ¨æ‰“åŒ…æ—¶è‡ªåŠ¨å‹ç¼©å›¾ç‰‡ï¼Œæˆ–è€…ä½¿ç”¨ `vite-plugin-webp` å°†å›¾ç‰‡è½¬æ¢ä¸ºä¸‹ä¸€ä»£ WebP æ ¼å¼ã€‚

### 2. èµ„æºå†…è”é™åˆ¶

é€šè¿‡ `assetsInlineLimit` æ§åˆ¶ Base64 å†…è”ã€‚å¤ªå¤§çš„å›¾ç‰‡å†…è”ä¼šå¯¼è‡´ JS ä½“ç§¯è¿‡å¤§ï¼Œè¿‡å°çš„å›¾ç‰‡å†…è”å¯ä»¥å‡å°‘ HTTP è¯·æ±‚ã€‚

```javascript
build: {
  assetsInlineLimit: 4096, // 4kb ä»¥ä¸‹çš„èµ„æºå†…è”ä¸º base64
}

```

---

## ä¸‰ã€ å¼€å‘ç¯å¢ƒä½“éªŒä¼˜åŒ–

### 1. é¢„æ„å»ºä¾èµ– (Dependency Pre-Bundling)

å¦‚æœä½ çš„é¡¹ç›®æœ‰å¾ˆå¤š CommonJS çš„ä¾èµ–ï¼ŒVite å¯åŠ¨æ—¶ä¼šæ…¢ã€‚å¯ä»¥åœ¨ `optimizeDeps` ä¸­å¼ºåˆ¶é¢„æ„å»ºæŸäº›åŒ…ã€‚

```javascript
optimizeDeps: {
  include: ['axios', 'echarts', '@antfu/utils'],
}

```

### 2. å¼€å¯ç¼“å­˜

ç¡®ä¿ Vite çš„ `.vite` ç¼“å­˜ç›®å½•æ²¡æœ‰è¢«è¯¯åˆ ã€‚Vite ä¼šå°†é¢„æ„å»ºçš„ä¾èµ–ç¼“å­˜ï¼Œç¬¬äºŒæ¬¡å¯åŠ¨å‡ ä¹æ˜¯ç¬é—´å®Œæˆã€‚

---

## å››ã€ è¿›é˜¶ï¼šæŒ‰éœ€å¼•å…¥ä¸ Tree Shaking

### 1. è‡ªåŠ¨å¯¼å…¥æ’ä»¶

ä½¿ç”¨ `unplugin-auto-import` å’Œ `unplugin-vue-components`ã€‚è¿™ä¸ä»…èƒ½å‡å°‘ `import` è¯­å¥ï¼Œæ›´é‡è¦çš„æ˜¯å®ƒæ”¯æŒ **ç»„ä»¶çº§åˆ«çš„ Tree Shaking**ï¼Œåªæ‰“åŒ…ä½ ç”¨åˆ°çš„ç»„ä»¶ã€‚

```javascript
import AutoImport from "unplugin-auto-import/vite";
import Components from "unplugin-vue-components/vite";

plugins: [
  AutoImport({ resolvers: [ElementPlusResolver()] }),
  Components({ resolvers: [ElementPlusResolver()] }),
];
```

### 2. è§†è§‰åˆ†æå·¥å…·

å®‰è£… `rollup-plugin-visualizer`ï¼Œæ‰“åŒ…åå®ƒä¼šç”Ÿæˆä¸€ä¸ª HTML é¡µé¢ï¼Œé€šè¿‡çŸ©å½¢æ ‘å›¾æ¸…æ™°å±•ç¤ºæ¯ä¸ªä¾èµ–å ç”¨çš„ç©ºé—´ï¼Œå¸®åŠ©ä½ â€œé’ˆå¯¹æ€§å‡è‚¥â€ã€‚

---

## äº”. é…ç½®å‚è€ƒ

### ä¼˜åŒ–é¡¹

1. å¯ç”¨é¢„å‹ç¼© (Gzip & Brotli)
   å®‰è£…`vite-plugin-compression`ï¼Œé…ç½® gzipã€br é™æ€å‹ç¼©
2. manualChunks è°ƒæ•´
   é€šè¿‡`rollup-plugin-visualizer`ï¼Œè°ƒæ•´`manualChunks` é…ç½®ï¼Œå¯¹ nodemodulesã€é¡µé¢åˆ†åŒ…
3. å›¾ç‰‡å¤„ç†
   å®‰è£…`vite-imagetools`ï¼Œè½¬æ¢å›¾ç‰‡

```ts
import productOverviewPcWebp from "@/assets/home/overview.png?format=webp";
import productOverviewMobileAvif from "@/assets/home/overview.png?w=750&format=avif";
```

4. æŒ‰éœ€å¼•å…¥
   å®‰è£…`unplugin-auto-import/viteã€unplugin-vue-components/vite`ï¼Œç»„ä»¶çº§ tree Shaking

```ts
import { copyFileSync, existsSync } from "node:fs";
import path from "node:path";

import vue from "@vitejs/plugin-vue";
import vueJsx from "@vitejs/plugin-vue-jsx";
import postCssPxToRem from "postcss-pxtorem";
import { visualizer } from "rollup-plugin-visualizer";
import AutoImport from "unplugin-auto-import/vite";
import { TDesignResolver } from "unplugin-vue-components/resolvers";
import Components from "unplugin-vue-components/vite";
import type { ConfigEnv, UserConfig } from "vite";
import { loadEnv } from "vite";
import { imagetools } from "vite-imagetools";
import viteCompression from "vite-plugin-compression";
import { viteMockServe } from "vite-plugin-mock";
import svgLoader from "vite-svg-loader";

const CWD = process.cwd();

// https://vitejs.dev/config/
export default ({ mode }: ConfigEnv): UserConfig => {
  const { VITE_BASE_URL, VITE_API_URL_PREFIX, VITE_API_URL } = loadEnv(
    mode,
    CWD
  );

  return {
    base: VITE_BASE_URL,
    resolve: {
      alias: {
        "@": path.resolve(__dirname, "./src"),
      },
      extensions: [".mjs", ".js", ".ts", ".jsx", ".tsx", ".json", ".vue"],
    },

    esbuild: {
      drop:
        mode === "release" || mode === "site" ? ["console", "debugger"] : [],
    },

    build: {
      target: "esnext", // ç°ä»£æµè§ˆå™¨ï¼Œäº§ç‰©æ›´å°
      cssTarget: "chrome80",
      chunkSizeWarningLimit: 1000, // æé«˜å¤§åŒ…è­¦å‘Šé˜ˆå€¼
      assetsInlineLimit: 4096, // å†…è”å°äº4kçš„èµ„æº
      minify: "esbuild", // esbuild æ¯” terser å¿« 10-40 å€
      cssCodeSplit: true, // CSS æ‹†åˆ†
      sourcemap: false, // ç”Ÿäº§ç¯å¢ƒå…³é—­ sourcemap å‡å°ä½“ç§¯

      rollupOptions: {
        output: {
          chunkFileNames: "assets/js/[name]-[hash].js", // åˆ†å—æ–‡ä»¶- éé¡µé¢
          entryFileNames: "assets/js/[name]-[hash].js", // é¡µé¢å…¥å£æ–‡ä»¶
          assetFileNames: "assets/[ext]/[name]-[hash].[ext]", // éjsèµ„æº
          manualChunks: (id) => {
            if (id.includes("node_modules")) {
              if (id.includes("tdesign-vue-next")) {
                return "tdesign-vendor";
              }
              if (id.includes("echarts")) {
                return "echarts-vendor";
              }
              if (id.includes("lodash")) {
                return "lodash-vendor";
              }
              // è°ƒæ•´ vueç›¸å…³åº“ é¡ºåºï¼Œé¿å…tdesign-vue-next åˆå…¥
              if (
                id.includes("pinia") ||
                id.includes("vue-router") ||
                id.includes("@vueuse")
              ) {
                return "vue-vendor";
              }
              return "vendor";
            }

            // é€»è¾‘ï¼šå¦‚æœæ˜¯ src/views ç›®å½•ä¸‹çš„æ–‡ä»¶
            if (id.includes("src/pages")) {
              // æå–æ¨¡å—åï¼Œä¾‹å¦‚ src/views/order/index.vue -> order
              const modules = id.toString().split("src/pages/")[1].split("/");
              const moduleName = modules[0];

              // å°†è¯¥æ¨¡å—ä¸‹çš„æ‰€æœ‰è§†å›¾ç»„ä»¶èšåˆåœ¨ä¸€èµ·
              return `view-${moduleName}`;
            }
          },
        },
      },
    },

    css: {
      preprocessorOptions: {
        less: {
          modifyVars: {
            hack: `true; @import (reference) "${path.resolve(
              "src/style/variables.less"
            )}";`,
          },
          math: "strict",
          javascriptEnabled: true,
        },
      },
      postcss: {
        plugins: [
          postCssPxToRem({
            // è‡ªé€‚åº”ï¼Œpx>remè½¬æ¢
            rootValue: 192, // pcç«¯å»ºè®®ï¼š192ï¼Œç§»åŠ¨ç«¯å»ºè®®ï¼š75ï¼›è®¾è®¡ç¨¿å®½åº¦çš„1 / 10
            propList: ["*", "!border"], // é™¤ border å¤–æ‰€æœ‰px è½¬ rem // éœ€è¦è½¬æ¢çš„å±æ€§ï¼Œè¿™é‡Œé€‰æ‹©å…¨éƒ¨éƒ½è¿›è¡Œè½¬æ¢
            selectorBlackList: [".norem"], // è¿‡æ»¤æ‰norem-å¼€å¤´çš„classï¼Œä¸è¿›è¡Œremè½¬æ¢ï¼Œè¿™ä¸ªå†…å®¹å¯ä»¥ä¸å†™
            unitPrecision: 5, // è½¬æ¢åçš„ç²¾åº¦ï¼Œå³å°æ•°ç‚¹ä½æ•°
            replace: true, // æ˜¯å¦ç›´æ¥æ›´æ¢å±æ€§å€¼è€Œä¸æ·»åŠ å¤‡ä»½å±æ€§
            mediaQuery: false, // æ˜¯å¦åœ¨åª’ä½“æŸ¥è¯¢ä¸­ä¹Ÿè½¬æ¢pxä¸ºrem
            minPixelValue: 0, // è®¾ç½®è¦è½¬æ¢çš„æœ€å°åƒç´ å€¼
            exclude: (file: string) => {
              const whiteList = ["home/index.vue"]; // ç™½åå•ï¼Œåªè½¬æ¢ç™½åå•å†…
              // å¦‚æœæ–‡ä»¶è·¯å¾„åŒ…å«ç™½åå•ä¸­çš„ä»»æ„ä¸€é¡¹ï¼Œåˆ™ä¸æ’é™¤ï¼ˆå³è¿›è¡Œè½¬æ¢ï¼‰
              return !whiteList.some((item) => file.includes(item));
            },
          }),
        ],
      },
    },

    plugins: [
      vue(),
      vueJsx(),
      viteMockServe({
        mockPath: "mock",
        enable: true,
      }),
      imagetools(),
      svgLoader(),
      AutoImport({
        imports: ["vue", "vue-router", "pinia", "@vueuse/core"],
        dts: "src/auto-imports.d.ts",
        resolvers: [TDesignResolver({ library: "vue-next" })],
      }),
      Components({
        dts: "src/components.d.ts",
        resolvers: [TDesignResolver({ library: "vue-next" })],
      }),
      viteCompression({
        verbose: true,
        disable: false,
        threshold: 10240,
        algorithm: "gzip",
        ext: ".gz",
      }),
      viteCompression({
        verbose: true,
        disable: false,
        threshold: 10240,
        algorithm: "brotliCompress",
        ext: ".br",
      }),
      visualizer({
        open: true,
        gzipSize: true,
        brotliSize: true,
      }) as any,
      {
        name: "generate-spa-fallback",
        apply: "build",
        enforce: "post",
        closeBundle() {
          const distIndex = path.resolve(CWD, "dist/index.html");
          const distSpa = path.resolve(CWD, "dist/fallback.html");
          if (existsSync(distIndex)) {
            copyFileSync(distIndex, distSpa);
            console.log("\nGenerated SPA fallback: dist/fallback.html");
          }
        },
      },
      {
        name: "generate-sitemap",
        apply: "build",
        enforce: "post",
        closeBundle() {
          // åŠ¨æ€å¯¼å…¥Sitemapç”Ÿæˆè„šæœ¬
          import("./scripts/generate-sitemap.js" as string)
            .then((module: any) => {
              module.main();
            })
            .catch((error) => {
              console.error("âŒ Failed to generate sitemap:", error);
            });
        },
      },
    ],

    server: {
      port: 3002,
      host: "0.0.0.0",
      open: true, // è¿™é‡Œå¼€å¯è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨æ˜¯å¯é€‰é¡¹
      warmup: {
        clientFiles: ["./src/main.ts", "./src/pages/**/*.vue"],
      },
      proxy: {
        [VITE_API_URL_PREFIX]: {
          target: VITE_API_URL,
          changeOrigin: true,
          rewrite: (path) => {
            return path.replace(/^\/api/, "/portalSrv/api");
          },
        },
      },
    },

    ssr: {
      noExternal: [
        "tdesign-vue-next",
        "tvision-color",
        "@material/material-color-utilities",
        "chroma-js",
      ],
    },

    ssgOptions: {
      script: "async",
      formatting: "minify",
      crittersOptions: false,
      includedRoutes() {
        // ä»…åŒ…å«é¦–é¡µ
        return ["/"];
      },
    },
  };
};
```

### ğŸ’¡ å…³é”®å»ºè®®ï¼š

- **ä¸è¦è¿‡åº¦ä¼˜åŒ–**ï¼šå¦‚æœé¡¹ç›®ä¸å¤§ï¼Œé»˜è®¤é…ç½®å·²ç»è¶³å¤Ÿã€‚
- **ä¼˜å…ˆ Brotli**ï¼šæ—¢ç„¶ä½ å·²ç»æŠ˜è…¾å¥½äº† Nginx çš„ Brotli æ¨¡å—ï¼Œå‰ç«¯æ„å»ºåŠ¡å¿…äº§å‡º `.br` æ–‡ä»¶ï¼Œè¿™æ˜¯æ”¶ç›Šæœ€é«˜çš„ä¸€é¡¹ã€‚
- **CDN åŠ é€Ÿ**ï¼šå¯¹äºæå¤§çš„åº“ï¼ˆå¦‚ Echarts, Three.jsï¼‰ï¼Œè€ƒè™‘ä½¿ç”¨ `vite-plugin-cdn-import` ä» CDN åŠ è½½ï¼Œè€Œä¸æ˜¯æ‰“å…¥æœ¬åœ°åŒ…ã€‚
