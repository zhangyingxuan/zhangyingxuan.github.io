---
title: 2023-08-18-ã€ç ”å‘ã€‘Gitee + è…¾è®¯äº‘æœåŠ¡å™¨è‡ªåŠ¨åŒ–éƒ¨ç½²
description: æå‡æ•ˆç‡ 10 å€ï¼šGitee/GitHub + è…¾è®¯äº‘ CVM å®ç° Vue 3 é¡¹ç›®è‡ªåŠ¨åŒ–éƒ¨ç½²
categories:
  - ç ”å‘
tags:
  - webhooks
---

## ğŸ—ï¸ è‡ªåŠ¨åŒ–éƒ¨ç½²æ ¸å¿ƒæ¶æ„

> ä¸ºäº†ä¸å°†æœåŠ¡å™¨è´¦å¯†æ³„æ¼ç»™ gitee/githubï¼Œæœ¬æ–‡ä½¿ç”¨ç»å…¸çš„ Webhook-Triggered CI/CD æ¨¡å¼ï¼Œå®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹ï¼š

1.  **ä»£ç æäº¤ï¼š** å¼€å‘è€…å°†ä»£ç æ¨é€åˆ° Git ä»“åº“ã€‚
2.  **Webhook è§¦å‘ï¼š** Git ä»“åº“è‡ªåŠ¨å‘é€ HTTP POST è¯·æ±‚ï¼ˆWebhookï¼‰åˆ°è…¾è®¯äº‘ CVM çš„æŒ‡å®šç«¯å£ã€‚
3.  **Webhook Server ç›‘å¬ï¼š** CVM ä¸Šçš„ Node.js æœåŠ¡æ¥æ”¶åˆ°è¯·æ±‚ã€‚
4.  **æ‰§è¡Œè„šæœ¬ï¼š** Node.js æœåŠ¡è¿è¡Œé¢„è®¾çš„ Shell è„šæœ¬ã€‚
5.  **éƒ¨ç½²åŠ¨ä½œï¼š** Shell è„šæœ¬æ‰§è¡Œ `git pull`ã€`npm install`ã€`npm run build` å’Œéƒ¨ç½²æ“ä½œã€‚
6.  **é¡¹ç›®æ›´æ–°ï¼š** æ–°çš„ Vue 3 æ„å»ºäº§ç‰©ä¸Šçº¿ï¼Œé€šè¿‡ Nginx æš´éœ²ç»™ç”¨æˆ·ã€‚

### **âœ¨ Webhook äº¤äº’æµç¨‹**

æ‰§è¡Œæ—¶åºï¼Œä»£ç æ¨é€åï¼Œç³»ç»Ÿã€ä»“åº“ã€æœåŠ¡å™¨

```mermaid
sequenceDiagram
    participant D as Developer
    participant R as Gitee Repository
    participant S as Webhook Server
    participant A as Deploy Server

    Note over D,A: ä»£ç æ¨é€åç³»ç»Ÿé—´äº¤äº’æµç¨‹

    %% ä»£ç æ¨é€é˜¶æ®µ
    D->>R: git push origin master
    R->>R: æ›´æ–°ä»£ç ä»“åº“
    R->>R: è§¦å‘ Push Event

    %% Webhook è§¦å‘é˜¶æ®µ
    R->>S: POST /webhook (Push Event)
    Note right of R: Headers:<br/>X-Gitee-Token: sha256=xxx<br/>X-Gitee-Event: push<br/>Body: {ref, commits}

    %% æœåŠ¡å™¨å¤„ç†é˜¶æ®µ
    S->>S: éªŒè¯ç­¾å(X-Gitee-Token)
    alt ç­¾åéªŒè¯å¤±è´¥
        S->>R: è¿”å› 401 Unauthorized
    else ç­¾åéªŒè¯æˆåŠŸ
        S->>S: æ£€æŸ¥åˆ†æ”¯å’Œç›®æ ‡ç›®å½•å˜æ›´
        alt æ— éœ€éƒ¨ç½²
            S->>R: è¿”å› 200 OK (skipped)
        else éœ€è¦éƒ¨ç½²
            S->>A: æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
            A->>A: æ‹‰å–æœ€æ–°ä»£ç 
            A->>A: é‡å¯åº”ç”¨æœåŠ¡
            A-->>S: è¿”å›éƒ¨ç½²ç»“æœ
            S->>R: è¿”å› 200 OK (success/failed)
        end
    end

    %% å®Œæˆé€šçŸ¥
    R->>D: æ˜¾ç¤ºæ¨é€ç»“æœ
    Note over D,R: Webhookå¤„ç†å®Œæˆ
```

## ğŸ› ï¸ ç¬¬ä¸€æ­¥ï¼šæœåŠ¡å™¨åŸºç¡€ç¯å¢ƒé…ç½®

### 1. å‡†å¤‡å·¥ä½œ

- **è…¾è®¯äº‘ CVM (Linux)** ä¸€å°ã€‚
- **å®‰è£… Gitã€Node.js å’Œ PM2ï¼š**
  ```bash
  # å®‰è£… Node.js (æ¨èä½¿ç”¨ nvm ç®¡ç†ç‰ˆæœ¬)
  sudo apt install nodejs npm -y
  # å®‰è£… PM2 (ç”¨äºä¿æŒ Node.js Webhook æœåŠ¡å’Œå‰ç«¯åº”ç”¨ç¨³å®šè¿è¡Œ)
  npm install pm2 -g
  sudo apt install git -y
  ```

### 2. é…ç½® SSH å…å¯†æ‹‰å–ä»£ç 

ä¸ºäº†è®©æœåŠ¡å™¨æ— éœ€å¯†ç å³å¯æ‹‰å–ä»£ç ï¼Œéœ€è¦é…ç½® SSH å¯†é’¥ï¼š

1.  **ç”Ÿæˆå¯†é’¥ï¼š** åœ¨ CVM ä¸Šæ‰§è¡Œ `ssh-keygen -t rsa -C "your_email@example.com"`ï¼Œä¸€è·¯å›è½¦ï¼Œç”Ÿæˆå…¬é’¥å’Œç§é’¥ã€‚
2.  **æ·»åŠ å…¬é’¥ï¼š** å°†ç”Ÿæˆçš„å…¬é’¥æ–‡ä»¶å†…å®¹ (`~/.ssh/id_rsa.pub`) å¤åˆ¶ã€‚
3.  **é…ç½®ä»“åº“ï¼š** ç™»å½• Gitee æˆ– GitHubï¼Œè¿›å…¥**ç›®æ ‡ä»“åº“**çš„ **è®¾ç½® -\> éƒ¨ç½²å…¬é’¥ç®¡ç† (Gitee) / Deploy Keys (GitHub)**ï¼Œå°†å…¬é’¥ç²˜è´´è¿›å»å¹¶ä¿å­˜ã€‚

## ç¬¬äºŒæ­¥ï¼šWebhook æœåŠ¡æ­å»º

ä½¿ç”¨ NestJS 9.x å®ç° Webhook æœåŠ¡ï¼ˆæ”¯æŒ Lerna Monorepo ç›®å½•è¿‡æ»¤ï¼‰ï¼Œä¸“ä¸º Lerna Monorepo ç¯å¢ƒè®¾è®¡ï¼Œæ”¯æŒæŒ‡å®šç›®å½•å˜æ›´è¿‡æ»¤ã€‚

### é¡¹ç›®ç»“æ„

```bash
nest-webhook/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.module.ts          # ä¸»æ¨¡å—
â”‚   â”œâ”€â”€ main.ts                # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ webhook/
â”‚   â”‚   â”œâ”€â”€ webhook.controller.ts  # Webhook æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ webhook.module.ts      # Webhook æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ webhook.service.ts     # Webhook æœåŠ¡
â”‚   â”‚   â””â”€â”€ dto/               # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚       â””â”€â”€ webhook.dto.ts
â”‚   â””â”€â”€ deploy/
â”‚       â”œâ”€â”€ deploy.service.ts  # éƒ¨ç½²æœåŠ¡
â”‚       â””â”€â”€ deploy.module.ts   # éƒ¨ç½²æ¨¡å—
â”œâ”€â”€ .env.example               # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

### å®ç°æ­¥éª¤

#### 1. åˆ›å»º NestJS é¡¹ç›®

```bash
npm i -g @nestjs/cli
nest new nest-webhook
cd nest-webhook
npm install @nestjs/config dotenv crypto child_process axios
```

#### 2. ç¯å¢ƒå˜é‡é…ç½® (.env)

```env.dev
WEBHOOK_SECRET=vue3-deploy-secret-123
REPO_PATH=/opt/vue3-app/your-monorepo
BUILD_CMD=npm install && npm run build --workspace=web
DEPLOY_PATH=/opt/vue3-app/your-monorepo/packages/web/dist
WATCH_DIRS=packages/web/
TARGET_BRANCH=refs/heads/master
PORT=3000
```

#### 3. æ ¸å¿ƒä»£ç å®ç°

##### src/app.module.ts

```typescript
import { Module } from "@nestjs/common";
import { ConfigModule } from "@nestjs/config";
import { WebhookModule } from "./webhook/webhook.module";
import { DeployModule } from "./deploy/deploy.module";
const envFilePath = `.env.${process.env.NODE_ENV || "prod"}`;

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      envFilePath,
      cache: true, // å¯ç”¨ç¼“å­˜æé«˜æ€§èƒ½
    }),
    WebhookModule,
    DeployModule,
  ],
})
export class AppModule {}
```

##### src/main.ts

```typescript
import { NestFactory } from "@nestjs/core";
import { ValidationPipe } from "@nestjs/common";
import { AppModule } from "./app.module";
import { Logger } from "@nestjs/common";

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // app.useGlobalPipes(new ValidationPipe({
  //   whitelist: true,
  //   forbidNonWhitelisted: false, // æ”¹ä¸º false å…è®¸é¢å¤–å±æ€§
  //   transform: true, // è‡ªåŠ¨è½¬æ¢ç±»å‹
  //   skipMissingProperties: true, // è·³è¿‡ç¼ºå¤±å±æ€§
  // }));

  const port = process.env.PORT || 3002;
  await app.listen(port);
  Logger.log(
    `ğŸš€ Webhook server running on http://localhost:${port}`,
    "Bootstrap"
  );
}
bootstrap();
```

##### src/webhook/dto/webhook.dto.ts

```typescript
export class WebhookDto {
  readonly ref: string;
  readonly before: string;
  readonly after: string;
  readonly commits: Array<{
    id: string;
    message: string;
    added: string[];
    modified: string[];
    removed: string[];
    author: {
      name: string;
      email: string;
    };
    timestamp: string;
  }>;
  readonly repository: {
    name: string;
    url: string;
    homepage: string;
  };
  readonly sender: {
    login: string;
    id: number;
    avatar_url: string;
    url: string;
  };
}
```

##### src/webhook/webhook.service.ts

```typescript
import { Injectable, Logger } from "@nestjs/common";
import { ConfigService } from "@nestjs/config";
import * as crypto from "crypto";
import { WebhookDto } from "./dto/webhook.dto";
const querystring = require("querystring");

@Injectable()
export class WebhookService {
  private readonly logger = new Logger(WebhookService.name);

  constructor(private configService: ConfigService) {}

  /**
   * ç”Ÿæˆ Gitee é£æ ¼çš„ç­¾å
   * @param {string} secret å¯†é’¥
   * @returns {object} { timestamp, signature }
   */
  generateSignature(secret) {
    const timestamp = Date.now();
    const stringToSign = `${timestamp}\n${secret}`;

    const hmac = crypto.createHmac("sha256", secret);
    hmac.update(stringToSign);

    const signData = hmac.digest();
    const base64Sign = signData.toString("base64");
    const urlEncodedSign = querystring.escape(base64Sign);

    return { timestamp, signature: urlEncodedSign };
  }

  /**
   * éªŒè¯ Gitee ç­¾å
   * @param {number} timestamp æ—¶é—´æˆ³
   * @param {string} receivedSignature æ¥æ”¶åˆ°çš„ç­¾å
   * @param {number} tolerance æ—¶é—´å®¹å·®ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤5åˆ†é’Ÿï¼‰
   * @returns {boolean} æ˜¯å¦æœ‰æ•ˆ
   */
  verifySignature(timestamp, receivedSignature, tolerance = 3600000) {
    // 1. æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
    const currentTimestamp = Date.now();
    if (Math.abs(currentTimestamp - timestamp) > tolerance) {
      console.warn("Signature expired or timestamp invalid");
      return false;
    }

    const secret = this.configService.get<string>("WEBHOOK_SECRET");
    // 2. é‡æ–°è®¡ç®—ç­¾å
    const stringToSign = `${timestamp}\n${secret}`;
    const hmac = crypto.createHmac("sha256", secret);
    hmac.update(stringToSign);
    const signData = hmac.digest();
    const expectedBase64 = signData.toString("base64");
    const expectedSignature = querystring.escape(expectedBase64);

    // 3. å®‰å…¨æ¯”è¾ƒç­¾å
    return this.safeCompare(receivedSignature, expectedSignature);
  }

  /**
   * å®‰å…¨æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²ï¼ˆé˜²æ­¢æ—¶åºæ”»å‡»ï¼‰
   */
  safeCompare(a, b) {
    if (a.length !== b.length) return false;

    const bufA = Buffer.from(a);
    const bufB = Buffer.from(b);

    return crypto.timingSafeEqual(bufA, bufB);
  }

  isWatchDirChanged(commits: WebhookDto["commits"]): boolean {
    const watchDirs = this.configService.get<string>("WATCH_DIRS").split(",");

    for (const commit of commits) {
      const changedFiles = [
        ...(commit.added || []),
        ...(commit.modified || []),
        ...(commit.removed || []),
      ];

      for (const file of changedFiles) {
        for (const dir of watchDirs) {
          const normalizedDir = dir.endsWith("/") ? dir : `${dir}/`;
          if (file.startsWith(normalizedDir)) {
            this.logger.log(
              `Detected change in watch dir: ${file} (dir: ${dir})`
            );
            return true;
          }
        }
      }
    }

    return false;
  }
}
```

##### src/webhook/webhook.controller.ts

```typescript
import {
  Controller,
  Post,
  Body,
  Headers,
  HttpException,
  HttpStatus,
  Logger,
} from "@nestjs/common";
import { WebhookService } from "./webhook.service";
import { DeployService } from "../deploy/deploy.service";
import { WebhookDto } from "./dto/webhook.dto";

@Controller("webhook")
export class WebhookController {
  private readonly logger = new Logger(WebhookController.name);

  constructor(
    private readonly webhookService: WebhookService,
    private readonly deployService: DeployService
  ) {}

  @Post()
  async handleWebhook(
    @Body() payload: WebhookDto,
    @Headers("x-gitee-token") signature: string,
    @Headers("x-gitee-event") eventType: string
  ) {
    try {
      // 1. éªŒè¯äº‹ä»¶ç±»å‹
      if (eventType !== "push") {
        this.logger.warn(`Ignored event: ${eventType}`);
        throw new HttpException(
          `Unsupported event type: ${eventType}`,
          HttpStatus.BAD_REQUEST
        );
      }

      // 2. éªŒè¯ç­¾å
      if (!this.webhookService.verifySignature(payload, signature)) {
        this.logger.warn("Invalid signature received");
        throw new HttpException("Invalid signature", HttpStatus.FORBIDDEN);
      }

      // 3. æ£€æŸ¥åˆ†æ”¯
      const targetBranch = process.env.TARGET_BRANCH || "refs/heads/master";
      if (payload.ref !== targetBranch) {
        this.logger.log(
          `Skipped non-target branch: ${payload.ref} (target: ${targetBranch})`
        );
        return { status: "skipped", reason: "non-target-branch" };
      }

      // 4. æ£€æŸ¥å˜æ›´æ–‡ä»¶
      if (!payload.commits || payload.commits.length === 0) {
        this.logger.log("No commits in push event");
        return { status: "skipped", reason: "no-commits" };
      }

      const hasWatchDirChange = this.webhookService.isWatchDirChanged(
        payload.commits
      );
      if (!hasWatchDirChange) {
        this.logger.log(
          `No changes in watched directories: ${process.env.WATCH_DIRS}`
        );
        return { status: "skipped", reason: "no-watched-changes" };
      }

      // 5. æ‰§è¡Œéƒ¨ç½²
      this.logger.log("Starting deployment...");
      const result = await this.deployService.deploy();

      return {
        status: "success",
        message: "Deployment completed successfully",
        details: result,
      };
    } catch (error) {
      this.logger.error(
        `Webhook processing failed: ${error.message}`,
        error.stack
      );
      throw new HttpException(
        error.response || "Internal server error",
        error.status || HttpStatus.INTERNAL_SERVER_ERROR
      );
    }
  }
}
```

##### src/deploy/deploy.service.ts

```typescript
import { Injectable, Logger } from "@nestjs/common";
import { ConfigService } from "@nestjs/config";
import { exec } from "child_process";
import { promisify } from "util";

const execAsync = promisify(exec);

@Injectable()
export class DeployService {
  private readonly logger = new Logger(DeployService.name);

  constructor(private configService: ConfigService) {}

  async deploy(): Promise<{ stdout: string; stderr: string }> {
    const repoPath = this.configService.get<string>("REPO_PATH");
    const buildCmd = this.configService.get<string>("BUILD_CMD");

    this.logger.log(`Executing deployment in ${repoPath}`);
    this.logger.log(`Build command: ${buildCmd}`);

    try {
      // 1. æ‹‰å–æœ€æ–°ä»£ç 
      this.logger.log("Pulling latest code...");
      await execAsync("git pull", { cwd: repoPath });

      // 2. æ‰§è¡Œæ„å»ºå‘½ä»¤
      this.logger.log("Building project...");
      const { stdout, stderr } = await execAsync(buildCmd, { cwd: repoPath });

      this.logger.log("Deployment completed successfully");
      this.logger.debug(`Build output: ${stdout}`);
      if (stderr) this.logger.warn(`Build warnings: ${stderr}`);

      return { stdout, stderr };
    } catch (error) {
      this.logger.error(`Deployment failed: ${error.message}`);
      this.logger.error(`Error output: ${error.stderr}`);
      throw error;
    }
  }
}
```

#### 4. æ¨¡å—é…ç½®

##### src/webhook/webhook.module.ts

```typescript
import { Module } from "@nestjs/common";
import { WebhookController } from "./webhook.controller";
import { WebhookService } from "./webhook.service";
import { DeployModule } from "../deploy/deploy.module";
import { ConfigModule } from "@nestjs/config";

@Module({
  imports: [ConfigModule, DeployModule],
  controllers: [WebhookController],
  providers: [WebhookService],
})
export class WebhookModule {}
```

#### src/deploy/deploy.module.ts

```typescript
import { Module } from "@nestjs/common";
import { DeployService } from "./deploy.service";
import { ConfigModule } from "@nestjs/config";

@Module({
  imports: [ConfigModule],
  providers: [DeployService],
  exports: [DeployService],
})
export class DeployModule {}
```

#### 5. éƒ¨ç½²åˆ°æœåŠ¡å™¨

##### å®‰è£… PM2 è¿›ç¨‹ç®¡ç†å™¨

```bash
npm install pm2 -g
```

##### åˆ›å»º ecosystem.config.js

```javascript
module.exports = {
  apps: [
    {
      name: "nest-webhook",
      script: "dist/main.js",
      instances: "max",
      autorestart: true,
      watch: false,
      max_memory_restart: "1G",
      env: {
        NODE_ENV: "production",
      },
      env_production: {
        NODE_ENV: "production",
      },
    },
  ],
};
```

##### æ„å»ºå¹¶å¯åŠ¨

```bash
npm run build
pm2 start ecosystem.config.js --env production
pm2 save
pm2 startup
```

### 6. Gitee Webhook é…ç½®

1. è¿›å…¥ Gitee ä»“åº“ â†’ ç®¡ç† â†’ WebHooks â†’ æ·»åŠ  WebHook
2. URL: `http://your-server-ip:3000/webhook`
3. äº‹ä»¶: é€‰æ‹© "æ¨é€äº‹ä»¶"
4. Secret: ä¸ `.env` ä¸­çš„ `WEBHOOK_SECRET` ä¸€è‡´
5. ç‚¹å‡»æ·»åŠ 
   > [gitee ç­¾åè®¡ç®—æ–¹æ³•è¯´æ˜](https://gitee.com/help/articles/4290#article-header2ï¼‰

## ğŸ‰ ç¬¬ä¸‰æ­¥ï¼šNginx é…ç½®ä¸æœ€ç»ˆæµ‹è¯•

ç”±äº Vue 3 é¡¹ç›®æ˜¯é™æ€æ–‡ä»¶ï¼Œéœ€è¦é€šè¿‡ Nginx è¿›è¡Œåå‘ä»£ç†å’Œæ‰˜ç®¡ã€‚

1.  **å®‰è£… Nginx**ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰ï¼š`sudo apt install nginx -y`
2.  **é…ç½® Nginx è™šæ‹Ÿä¸»æœºï¼š**

    ```nginx
    server {
        listen 80;
        server_name <æ‚¨çš„åŸŸåæˆ–IP>; # ä¾‹å¦‚ example.com

        location / {
            # æŒ‡å‘æ‚¨ Vue 3 æ„å»ºåçš„ dist ç›®å½•
            root /home/www/my-vue3-app/dist;
            index index.html;
            try_files $uri $uri/ /index.html; # SPA è·¯ç”±é…ç½®
        }
    }
    ```

3.  **é‡è½½ Nginxï¼š** `sudo nginx -s reload`

## ğŸ”§ ç¬¬å››æ­¥ï¼šæµ‹è¯•ä¸éªŒè¯

### 1. æµ‹è¯•æœ‰æ•ˆè¯·æ±‚

```bash
curl -X POST http://localhost:3000/webhook \
  -H "Content-Type: application/json" \
  -H "X-Gitee-Token: sha256=è®¡ç®—å‡ºçš„ç­¾å" \
  -H "X-Gitee-Event: push" \
  -d '{
    "ref": "refs/heads/master",
    "commits": [
      {
        "added": ["packages/web/new-file.txt"],
        "modified": ["packages/web/src/App.vue"],
        "removed": []
      }
    ]
  }'
```

### 2. æµ‹è¯•æ— æ•ˆè¯·æ±‚

```bash
# æ— æ•ˆç­¾å
curl -X POST http://localhost:3000/webhook \
  -H "Content-Type: application/json" \
  -H "X-Gitee-Token: invalid_signature" \
  -H "X-Gitee-Event: push" \
  -d '{}'

# éæ¨é€äº‹ä»¶
curl -X POST http://localhost:3000/webhook \
  -H "Content-Type: application/json" \
  -H "X-Gitee-Token: valid_signature" \
  -H "X-Gitee-Event: issue_created" \
  -d '{}'
```

## ï¼ˆéå¿…é¡»ï¼‰é«˜çº§åŠŸèƒ½æ‰©å±•

### 1. æ·»åŠ éƒ¨ç½²é’©å­

åœ¨ `deploy.service.ts` ä¸­æ·»åŠ éƒ¨ç½²å‰åçš„é’©å­å‡½æ•°ï¼š

```typescript
async deploy(): Promise<any> {
  await this.beforeDeploy();

  const result = await this.executeDeployCommands();

  await this.afterDeploy(result);
  return result;
}

private async beforeDeploy() {
  this.logger.log('Running pre-deployment tasks...');
  // å¤‡ä»½å½“å‰ç‰ˆæœ¬ã€é€šçŸ¥ç­‰
}

private async afterDeploy(result) {
  this.logger.log('Running post-deployment tasks...');
  // æ¸…ç†ç¼“å­˜ã€å‘é€é€šçŸ¥ç­‰
}
```

## æ€»ç»“

è¿™ä¸ª NestJS 9.x å®ç°çš„ Webhook æœåŠ¡å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¸…æ™°åˆ†ç¦» Webhook å¤„ç†å’Œéƒ¨ç½²é€»è¾‘
2. **Monorepo æ”¯æŒ**ï¼šé€šè¿‡ç›®å½•è¿‡æ»¤åªæ„å»ºå˜æ›´çš„å­é¡¹ç›®
3. **å®‰å…¨å¯é **ï¼š
   - ç­¾åéªŒè¯é˜²æ­¢ä¼ªé€ è¯·æ±‚
   - ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿé…ç½®
   - ç»“æ„åŒ–é”™è¯¯å¤„ç†
4. **å¯æ‰©å±•æ€§**ï¼š
   - æ˜“äºæ·»åŠ æ–°çš„é€šçŸ¥æ¸ é“
   - æ”¯æŒéƒ¨ç½²å‰åé’©å­
   - å¯é…ç½®æ„å»ºå‘½ä»¤å’Œç›®æ ‡åˆ†æ”¯
5. **ç”Ÿäº§å°±ç»ª**ï¼š
   - PM2 è¿›ç¨‹ç®¡ç†
   - æ—¥å¿—è®°å½•
   - å¥åº·æ£€æŸ¥ç«¯ç‚¹

é€šè¿‡è¿™ä¸ªå®ç°ï¼Œä½ å¯ä»¥è½»æ¾åœ°åœ¨ Lerna Monorepo ç¯å¢ƒä¸­å®ç°"ä»…å½“æŒ‡å®šç›®å½•å˜æ›´æ—¶æ‰è§¦å‘æ„å»ºéƒ¨ç½²"çš„è‡ªåŠ¨åŒ–æµç¨‹ï¼Œå¤§å¹…æå‡å¼€å‘æ•ˆç‡å’Œèµ„æºåˆ©ç”¨ç‡ã€‚

## é—®é¢˜

1. ç”±äºè…¾è®¯äº‘æœåŠ¡å™¨èµ„æºæœ‰é™ 1C1G + 2C2Gï¼Œç¼–è¯‘éå¸¸åƒèµ„æºï¼Œè¿™é‡Œå°†ç¼–è¾‘æ­¥éª¤æ”¾åˆ° gitee ä¸­ï¼Œwebhook ä»…åš git pull æ“ä½œ

```mermaid
sequenceDiagram
    participant D as Developer
    participant R as Gitee Repository
    participant S as Webhook Server

    D->>R: æ¨é€ä»£ç è‡³masteråˆ†æ”¯
    R->>R: æ›´æ–°ä»£ç ä»“åº“
    R->>R: è§¦å‘ CIï¼Œå¦‚æœæ¶‰åŠClientä»“åº“ï¼Œåˆ™ç¼–è¯‘
    R->>S: ç¼–è¯‘å®Œæˆåï¼ŒPOST /webhook (Push Event)
    Note right of R: Headers:<br/>X-Gitee-Token: sha256=xxx<br/>X-Gitee-Event: push<br/>Body: {ref, commits}

    %% æœåŠ¡å™¨å¤„ç†é˜¶æ®µ
    S->>S: éªŒè¯ç­¾å(X-Gitee-Token)
    alt ç­¾åéªŒè¯å¤±è´¥
        S->>R: è¿”å› 401 Unauthorized
    else ç­¾åéªŒè¯æˆåŠŸ
        S->>S: æ£€æŸ¥åˆ†æ”¯å’Œç›®æ ‡ç›®å½•å˜æ›´
        alt æ— éœ€éƒ¨ç½²
            S->>R: è¿”å› 200 OK (skipped)
        else éœ€è¦éƒ¨ç½²
            S->>A: æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
            A->>A: æ‹‰å–æœ€æ–°ä»£ç 
            A->>A: é‡å¯åº”ç”¨æœåŠ¡
            A-->>S: è¿”å›éƒ¨ç½²ç»“æœ
            S->>R: è¿”å› 200 OK (success/failed)
        end
    end
```

```mermaid
graph TD
    subgraph "Gitee æµæ°´çº¿å…¨æµç¨‹"
        A[ä»£ç æ¨é€è‡³ Gitee ä»“åº“] --> B{Gitee Go è§¦å‘å™¨};
        B -->|åŒ¹é…åˆ†æ”¯+è·¯å¾„| C[æ‹‰å–å®Œæ•´ä»£ç ];
        C --> D[æ£€æµ‹ packages/client ç›®å½•å˜æ›´];
        D -->|æœ‰å˜æ›´| E[å®‰è£…ä¾èµ–å¹¶æ„å»º client];
        D -->|æ— å˜æ›´| F[è·³è¿‡æ„å»ºï¼Œç»“æŸ];
        E --> G[æäº¤ dist åˆ°ä»“åº“];
        G --> H[è°ƒç”¨æœåŠ¡å™¨ Webhook];
        H --> I[æœåŠ¡å™¨æ‹‰å–ä»£ç +é‡å¯æœåŠ¡];
        F --> J[ç»“æŸ];
    end
    style A fill:#4CAF50,stroke:#333,stroke-width:2px
    style I fill:#2196F3,stroke:#333,stroke-width:2px
    style B fill:#FFC107,stroke:#333,stroke-width:2px
```

<!-- giteeæµæ°´çº¿è„šæœ¬ï¼Œä»…å‚è€ƒï¼Œæ— æ³•æ‰§è¡Œ -->

```shell
version: "1.0"
name: Client_Deploy
displayname: å‰ç«¯ç¼–è¯‘

# è§¦å‘æ¡ä»¶ï¼šåªæœ‰ master åˆ†æ”¯æ¨é€æ—¶æ‰è§¦å‘
triggers:
  - type: git_push
    branches: [master]

jobs:
  check-and-build:
    name: æ£€æŸ¥å˜æ›´å¹¶æ„å»ºClient
    runs-on: ubuntu-latest
    # Gitee Go æ”¯æŒçš„ Runner ç±»å‹
    steps:
      # 1. æ‹‰å–ä»£ç ï¼ˆå®Œæ•´å†å²ï¼Œç”¨äº diffï¼‰
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITEE_TOKEN }}
          # ä»“åº“ç§äººä»¤ç‰Œï¼ˆéœ€åœ¨ Gitee å¯†é’¥ç®¡ç†ä¸­é…ç½®ï¼‰
          fetch-depth: 0
          # æ‹‰å–æ‰€æœ‰å†å²æäº¤ï¼Œç¡®ä¿ diff å¯ç”¨

      # 2. æ£€æŸ¥ packages/client ç›®å½•å˜æ›´ï¼ˆä½¿ç”¨ Gitee Go å†…ç½® diff å·¥å…·ï¼‰
      - name: æ£€æµ‹Clientç›®å½•å˜æ›´
        id: check_changes
        # è·å–æœ¬æ¬¡æ¨é€çš„å˜æ›´æ–‡ä»¶ï¼ˆGitee Go å†…ç½®ç¯å¢ƒå˜é‡ï¼‰
        # GIT_PREVIOUS_COMMIT: æ¨é€å‰çš„ commit IDï¼ˆé¦–æ¬¡æ¨é€æ—¶ä¸ºå…¨é›¶å­—ç¬¦ä¸²ï¼‰
        # GIT_COMMIT: æ¨é€åçš„ commit ID
        run: |
          PREV_COMMIT="${{ env.GIT_PREVIOUS_COMMIT }}"
          CURRENT_COMMIT="${{ env.GIT_COMMIT }}"

          if [ "$PREV_COMMIT" = "0000000000000000000000000000000000000000" ]; then
            # é¦–æ¬¡æ¨é€ï¼šæ£€æŸ¥æ‰€æœ‰æäº¤çš„æ–‡ä»¶
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r $CURRENT_COMMIT)
          else
            # å¸¸è§„æ¨é€ï¼šæ£€æŸ¥ä¸¤æ¬¡æäº¤é—´çš„å˜æ›´
            CHANGED_FILES=$(git diff --name-only $PREV_COMMIT $CURRENT_COMMIT)
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰ packages/client ä¸‹çš„æ–‡ä»¶å˜æ›´
          CLIENT_CHANGED="false"
          while IFS= read -r file; do
            if [[ "$file" == packages/client/* ]]; then
              CLIENT_CHANGED="true"
              echo "æ£€æµ‹åˆ°å˜æ›´æ–‡ä»¶: $file"
              break
            fi
          done <<< "$CHANGED_FILES"

          # è®¾ç½®æ­¥éª¤è¾“å‡ºï¼ˆGitee Go é€šè¿‡ ::set-output æ¥æ”¶ï¼‰
          echo "client_changed=$CLIENT_CHANGED" >> $GITHUB_OUTPUT
          # æ³¨æ„ï¼šGitee Go å…¼å®¹ GitHub Actions è¾“å‡ºæ ¼å¼

      # 3. ä»…å½“ Client ç›®å½•å˜æ›´æ—¶æ‰§è¡Œæ„å»º
      - name: æ„å»ºå¹¶æäº¤ClientDist
        if: ${{ steps.check_changes.outputs.client_changed == 'true' }}
        # æ­£ç¡®å¼•ç”¨æ­¥éª¤è¾“å‡º
        run: |
          echo "===== å¼€å§‹æ„å»º packages/client ====="

          # å®‰è£… pnpmï¼ˆè‹¥æœªé¢„è£…ï¼‰
          npm install -g pnpm@8

          # å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨ pnpm workspaceï¼‰
          pnpm install --frozen-lockfile

          # ä»…æ„å»º client åŒ…ï¼ˆæ ¹æ®å®é™…é¡¹ç›®è°ƒæ•´å‘½ä»¤ï¼‰
          cd packages/client && pnpm run build

          # æäº¤æ„å»ºäº§ç‰©ï¼ˆdist ç›®å½•ï¼‰
          git config --local user.name "Gitee CI"
          git config --local user.email "ci@gitee.com"
          git add packages/client/dist -f
          # å¼ºåˆ¶æ·»åŠ ï¼ˆè¦†ç›– .gitignoreï¼‰
          git commit -m "chore: update client dist [skip ci]"
          # [skip ci] é¿å…å¾ªç¯è§¦å‘
          git push origin master
        env:
          GIT_AUTHOR_NAME: "Gitee CI"
          GIT_AUTHOR_EMAIL: "ci@gitee.com"
          GIT_COMMITTER_NAME: "Gitee CI"
          GIT_COMMITTER_EMAIL: "ci@gitee.com"

      # 4. æ— å˜æ›´æ—¶è·³è¿‡æ„å»ºï¼ˆå¯é€‰ï¼šæ·»åŠ æ—¥å¿—ï¼‰
      - name: è·³è¿‡æ„å»ºé€šçŸ¥
        if: ${{ steps.check_changes.outputs.client_changed == 'false' }}
        run: |
          echo "===== æœªæ£€æµ‹åˆ° packages/client å˜æ›´ï¼Œè·³è¿‡æ„å»º ====="
          echo "å˜æ›´æ–‡ä»¶åˆ—è¡¨:"
          echo "${{ steps.check_changes.outputs.changed_files }}"
```
